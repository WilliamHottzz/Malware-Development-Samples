#include "dbgcheck.h"
//#include "error.h"



/// <summary>
/// Wrapper of IsDebuggerPresent().
/// </summary>
/// <param name="process">Handle of the process.</param>
/// <returns>Returns 2 if debug flag was true.</returns>
int DebugPortCheck()
{
    NTSTATUS status;
    DWORD isDebuggerPresent = 0;
    DWORD err;
    auto founddbger = 0;
    pfnNtQueryInformationProcess NtQueryInformationProcess = NULL;
    auto ntdll = GetModuleHandleA(NtdllObf().c_str());


    if (ntdll != nullptr)
    {
        NtQueryInformationProcess = (pfnNtQueryInformationProcess)GetProcAddress(ntdll, NtQueryInformationProcessObf().c_str());

        if (NtQueryInformationProcess != nullptr)
        {
            status = NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &isDebuggerPresent, sizeof(DWORD), NULL);

            if (status == 0x00000000 && isDebuggerPresent != 0)
            {
                FreeLibrary(ntdll);     //  Unload from address.
                CloseHandle(ntdll);       //  Close handle.
                return DebuggerFound;
            }
            else
            {
                FreeLibrary(ntdll);
                CloseHandle(ntdll);
                return NoDebuggerFound;
            }
        }
        else
        {           
            FreeLibrary(ntdll);
            CloseHandle(ntdll);
            return FailedQuery;
        }
    }
    else
    {
        return FailedLoadingNtdll;
    } 
}


/// <summary>
/// Generates a software interrupt (int 3) to check for the presence of a debugger.
/// Handle this ho you want.
/// </summary>
inline void DebuggerSoftwareInterrupt()
{
    __try
    {
        __asm int 3;
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        //  If we get here, probably a debugger.
    }
}


inline int InlineAsmDebuggerCheck()
{
    BOOL found = FALSE;
    int result;

    __asm
    {
        xor eax, eax
        mov eax, fs: [0x30]     //  TLS.
        mov eax, [eax + 0x02]
        and eax, 0x000000FF     //  Mask.
        mov found, eax          //  IF 0 no dbg, IF 1 then dbg.
    }
    return result = found ? DebuggerFoundASM : NoDebuggerFound;
}